#![allow(unused)]
use crate::{
    font::editor::{parse_eset, EChar, ESet, OwnedESet, ECHAR_NULL},
    print::Page,
};
use anyhow::anyhow;
use image::ImageFormat;
use std::{
    collections::HashSet,
    path::{Path, PathBuf},
};
use structopt::StructOpt;

#[derive(Copy, Clone)]
pub enum KBCSet {
    Selected,
    Graphics,
    Labels,
}

/// These are the draw commands from the KBANTIK document,
/// used to render a keyboard layout
const KB_DRAW: [(u16, u16, u8, KBCSet); 688] = [
    (0, 52, 113, KBCSet::Graphics),
    (5, 52, 69, KBCSet::Labels),
    (9, 52, 115, KBCSet::Labels),
    (12, 52, 119, KBCSet::Graphics),
    (13, 52, 99, KBCSet::Labels),
    (22, 52, 101, KBCSet::Graphics),
    (37, 52, 113, KBCSet::Graphics),
    (52, 52, 119, KBCSet::Graphics),
    (59, 52, 101, KBCSet::Graphics),
    (74, 52, 113, KBCSet::Graphics),
    (86, 52, 119, KBCSet::Graphics),
    (96, 52, 101, KBCSet::Graphics),
    (111, 52, 113, KBCSet::Graphics),
    (123, 52, 119, KBCSet::Graphics),
    (133, 52, 101, KBCSet::Graphics),
    (148, 52, 113, KBCSet::Graphics),
    (160, 52, 119, KBCSet::Graphics),
    (170, 52, 101, KBCSet::Graphics),
    (185, 52, 113, KBCSet::Graphics),
    (197, 52, 119, KBCSet::Graphics),
    (207, 52, 101, KBCSet::Graphics),
    (222, 52, 113, KBCSet::Graphics),
    (234, 52, 119, KBCSet::Graphics),
    (244, 52, 101, KBCSet::Graphics),
    (259, 52, 113, KBCSet::Graphics),
    (271, 52, 119, KBCSet::Graphics),
    (281, 52, 101, KBCSet::Graphics),
    (296, 52, 113, KBCSet::Graphics),
    (308, 52, 119, KBCSet::Graphics),
    (318, 52, 101, KBCSet::Graphics),
    (333, 52, 113, KBCSet::Graphics),
    (345, 52, 119, KBCSet::Graphics),
    (355, 52, 101, KBCSet::Graphics),
    (370, 52, 113, KBCSet::Graphics),
    (382, 52, 119, KBCSet::Graphics),
    (392, 52, 101, KBCSet::Graphics),
    (407, 52, 113, KBCSet::Graphics),
    (419, 52, 119, KBCSet::Graphics),
    (429, 52, 101, KBCSet::Graphics),
    (444, 52, 113, KBCSet::Graphics),
    (456, 52, 119, KBCSet::Graphics),
    (466, 52, 101, KBCSet::Graphics),
    (481, 52, 113, KBCSet::Graphics),
    (493, 52, 119, KBCSet::Graphics),
    (503, 52, 101, KBCSet::Graphics),
    (518, 52, 113, KBCSet::Graphics),
    (523, 52, 66, KBCSet::Labels),
    (527, 52, 97, KBCSet::Labels),
    (531, 52, 99, KBCSet::Labels),
    (531, 52, 119, KBCSet::Graphics),
    (535, 52, 107, KBCSet::Labels),
    (539, 52, 115, KBCSet::Labels),
    (540, 52, 119, KBCSet::Graphics),
    (543, 52, 112, KBCSet::Labels),
    (547, 52, 97, KBCSet::Labels),
    (551, 52, 99, KBCSet::Labels),
    (555, 52, 101, KBCSet::Labels),
    (555, 52, 101, KBCSet::Graphics),
    (599, 52, 113, KBCSet::Graphics),
    (614, 52, 101, KBCSet::Graphics),
    (629, 52, 113, KBCSet::Graphics),
    (644, 52, 101, KBCSet::Graphics),
    (659, 52, 113, KBCSet::Graphics),
    (674, 52, 101, KBCSet::Graphics),
    (689, 52, 113, KBCSet::Graphics),
    (704, 52, 101, KBCSet::Graphics),
    (44, 64, 49, KBCSet::Selected),
    (57, 64, 33, KBCSet::Selected),
    (81, 64, 50, KBCSet::Selected),
    (98, 64, 34, KBCSet::Selected),
    (118, 64, 51, KBCSet::Selected),
    (131, 64, 32, KBCSet::Selected),
    (155, 64, 52, KBCSet::Selected),
    (169, 64, 36, KBCSet::Selected),
    (192, 64, 53, KBCSet::Selected),
    (204, 64, 37, KBCSet::Selected),
    (229, 64, 54, KBCSet::Selected),
    (239, 64, 38, KBCSet::Selected),
    (266, 64, 55, KBCSet::Selected),
    (276, 64, 47, KBCSet::Selected),
    (303, 64, 56, KBCSet::Selected),
    (313, 64, 40, KBCSet::Selected),
    (340, 64, 57, KBCSet::Selected),
    (355, 64, 41, KBCSet::Selected),
    (377, 64, 48, KBCSet::Selected),
    (390, 64, 61, KBCSet::Selected),
    (414, 64, 127, KBCSet::Selected),
    (428, 64, 63, KBCSet::Selected),
    (451, 64, 39, KBCSet::Selected),
    (461, 64, 96, KBCSet::Selected),
    (492, 64, 35, KBCSet::Selected),
    (503, 64, 94, KBCSet::Selected),
    (603, 64, 15, KBCSet::Selected),
    (614, 64, 1, KBCSet::Selected),
    (633, 64, 16, KBCSet::Selected),
    (642, 64, 2, KBCSet::Selected),
    (664, 64, 17, KBCSet::Selected),
    (672, 64, 3, KBCSet::Selected),
    (694, 64, 18, KBCSet::Selected),
    (703, 64, 4, KBCSet::Selected),
    (0, 74, 114, KBCSet::Graphics),
    (12, 74, 116, KBCSet::Graphics),
    (22, 74, 122, KBCSet::Graphics),
    (37, 74, 114, KBCSet::Graphics),
    (49, 74, 116, KBCSet::Graphics),
    (59, 74, 122, KBCSet::Graphics),
    (74, 74, 114, KBCSet::Graphics),
    (86, 74, 116, KBCSet::Graphics),
    (96, 74, 122, KBCSet::Graphics),
    (111, 74, 114, KBCSet::Graphics),
    (123, 74, 116, KBCSet::Graphics),
    (133, 74, 122, KBCSet::Graphics),
    (148, 74, 114, KBCSet::Graphics),
    (160, 74, 116, KBCSet::Graphics),
    (170, 74, 122, KBCSet::Graphics),
    (185, 74, 114, KBCSet::Graphics),
    (197, 74, 116, KBCSet::Graphics),
    (207, 74, 122, KBCSet::Graphics),
    (222, 74, 114, KBCSet::Graphics),
    (234, 74, 116, KBCSet::Graphics),
    (244, 74, 122, KBCSet::Graphics),
    (259, 74, 114, KBCSet::Graphics),
    (271, 74, 116, KBCSet::Graphics),
    (281, 74, 122, KBCSet::Graphics),
    (296, 74, 114, KBCSet::Graphics),
    (308, 74, 116, KBCSet::Graphics),
    (318, 74, 122, KBCSet::Graphics),
    (333, 74, 114, KBCSet::Graphics),
    (345, 74, 116, KBCSet::Graphics),
    (355, 74, 122, KBCSet::Graphics),
    (370, 74, 114, KBCSet::Graphics),
    (382, 74, 116, KBCSet::Graphics),
    (392, 74, 122, KBCSet::Graphics),
    (407, 74, 114, KBCSet::Graphics),
    (419, 74, 116, KBCSet::Graphics),
    (429, 74, 122, KBCSet::Graphics),
    (444, 74, 114, KBCSet::Graphics),
    (456, 74, 116, KBCSet::Graphics),
    (466, 74, 122, KBCSet::Graphics),
    (481, 74, 114, KBCSet::Graphics),
    (493, 74, 116, KBCSet::Graphics),
    (503, 74, 122, KBCSet::Graphics),
    (518, 74, 114, KBCSet::Graphics),
    (530, 74, 116, KBCSet::Graphics),
    (540, 74, 116, KBCSet::Graphics),
    (555, 74, 122, KBCSet::Graphics),
    (599, 74, 114, KBCSet::Graphics),
    (614, 74, 122, KBCSet::Graphics),
    (629, 74, 114, KBCSet::Graphics),
    (644, 74, 122, KBCSet::Graphics),
    (659, 74, 114, KBCSet::Graphics),
    (674, 74, 122, KBCSet::Graphics),
    (689, 74, 114, KBCSet::Graphics),
    (704, 74, 122, KBCSet::Graphics),
    (0, 84, 113, KBCSet::Graphics),
    (5, 84, 84, KBCSet::Labels),
    (9, 84, 97, KBCSet::Labels),
    (12, 84, 119, KBCSet::Graphics),
    (13, 84, 98, KBCSet::Labels),
    (22, 84, 119, KBCSet::Graphics),
    (37, 84, 101, KBCSet::Graphics),
    (52, 84, 113, KBCSet::Graphics),
    (67, 84, 119, KBCSet::Graphics),
    (74, 84, 101, KBCSet::Graphics),
    (89, 84, 113, KBCSet::Graphics),
    (101, 84, 119, KBCSet::Graphics),
    (111, 84, 101, KBCSet::Graphics),
    (126, 84, 113, KBCSet::Graphics),
    (138, 84, 119, KBCSet::Graphics),
    (148, 84, 101, KBCSet::Graphics),
    (163, 84, 113, KBCSet::Graphics),
    (175, 84, 119, KBCSet::Graphics),
    (185, 84, 101, KBCSet::Graphics),
    (200, 84, 113, KBCSet::Graphics),
    (212, 84, 119, KBCSet::Graphics),
    (222, 84, 101, KBCSet::Graphics),
    (237, 84, 113, KBCSet::Graphics),
    (249, 84, 119, KBCSet::Graphics),
    (259, 84, 101, KBCSet::Graphics),
    (274, 84, 113, KBCSet::Graphics),
    (286, 84, 119, KBCSet::Graphics),
    (296, 84, 101, KBCSet::Graphics),
    (311, 84, 113, KBCSet::Graphics),
    (323, 84, 119, KBCSet::Graphics),
    (333, 84, 101, KBCSet::Graphics),
    (348, 84, 113, KBCSet::Graphics),
    (360, 84, 119, KBCSet::Graphics),
    (370, 84, 101, KBCSet::Graphics),
    (385, 84, 113, KBCSet::Graphics),
    (397, 84, 119, KBCSet::Graphics),
    (407, 84, 101, KBCSet::Graphics),
    (422, 84, 113, KBCSet::Graphics),
    (434, 84, 119, KBCSet::Graphics),
    (444, 84, 101, KBCSet::Graphics),
    (459, 84, 113, KBCSet::Graphics),
    (471, 84, 119, KBCSet::Graphics),
    (481, 84, 101, KBCSet::Graphics),
    (496, 84, 113, KBCSet::Graphics),
    (508, 84, 119, KBCSet::Graphics),
    (518, 84, 101, KBCSet::Graphics),
    (533, 84, 113, KBCSet::Graphics),
    (538, 84, 68, KBCSet::Labels),
    (543, 84, 101, KBCSet::Labels),
    (546, 84, 119, KBCSet::Graphics),
    (547, 84, 108, KBCSet::Labels),
    (549, 84, 101, KBCSet::Labels),
    (553, 84, 116, KBCSet::Labels),
    (555, 84, 101, KBCSet::Graphics),
    (556, 84, 101, KBCSet::Labels),
    (599, 84, 113, KBCSet::Graphics),
    (614, 84, 101, KBCSet::Graphics),
    (629, 84, 113, KBCSet::Graphics),
    (644, 84, 101, KBCSet::Graphics),
    (659, 84, 113, KBCSet::Graphics),
    (674, 84, 101, KBCSet::Graphics),
    (689, 84, 113, KBCSet::Graphics),
    (704, 84, 101, KBCSet::Graphics),
    (59, 96, 113, KBCSet::Selected),
    (71, 96, 81, KBCSet::Selected),
    (94, 96, 119, KBCSet::Selected),
    (107, 96, 87, KBCSet::Selected),
    (133, 96, 101, KBCSet::Selected),
    (145, 96, 69, KBCSet::Selected),
    (170, 96, 114, KBCSet::Selected),
    (182, 96, 82, KBCSet::Selected),
    (207, 96, 116, KBCSet::Selected),
    (220, 96, 84, KBCSet::Selected),
    (244, 96, 122, KBCSet::Selected),
    (256, 96, 90, KBCSet::Selected),
    (281, 96, 117, KBCSet::Selected),
    (293, 96, 85, KBCSet::Selected),
    (318, 96, 105, KBCSet::Selected),
    (332, 96, 73, KBCSet::Selected),
    (353, 96, 111, KBCSet::Selected),
    (368, 96, 79, KBCSet::Selected),
    (392, 96, 112, KBCSet::Selected),
    (405, 96, 80, KBCSet::Selected),
    (429, 96, 64, KBCSet::Selected),
    (442, 96, 92, KBCSet::Selected),
    (466, 96, 43, KBCSet::Selected),
    (478, 96, 42, KBCSet::Selected),
    (604, 96, 26, KBCSet::Selected),
    (612, 96, 12, KBCSet::Selected),
    (633, 96, 27, KBCSet::Selected),
    (644, 96, 13, KBCSet::Selected),
    (663, 96, 28, KBCSet::Selected),
    (673, 96, 14, KBCSet::Selected),
    (694, 96, 30, KBCSet::Selected),
    (496, 100, 112, KBCSet::Graphics),
    (0, 106, 114, KBCSet::Graphics),
    (12, 106, 116, KBCSet::Graphics),
    (22, 106, 116, KBCSet::Graphics),
    (37, 106, 122, KBCSet::Graphics),
    (52, 106, 114, KBCSet::Graphics),
    (64, 106, 116, KBCSet::Graphics),
    (74, 106, 122, KBCSet::Graphics),
    (89, 106, 114, KBCSet::Graphics),
    (101, 106, 116, KBCSet::Graphics),
    (111, 106, 122, KBCSet::Graphics),
    (126, 106, 114, KBCSet::Graphics),
    (138, 106, 116, KBCSet::Graphics),
    (148, 106, 122, KBCSet::Graphics),
    (163, 106, 114, KBCSet::Graphics),
    (175, 106, 116, KBCSet::Graphics),
    (185, 106, 122, KBCSet::Graphics),
    (200, 106, 114, KBCSet::Graphics),
    (212, 106, 116, KBCSet::Graphics),
    (222, 106, 122, KBCSet::Graphics),
    (237, 106, 114, KBCSet::Graphics),
    (249, 106, 116, KBCSet::Graphics),
    (259, 106, 122, KBCSet::Graphics),
    (274, 106, 114, KBCSet::Graphics),
    (286, 106, 116, KBCSet::Graphics),
    (296, 106, 122, KBCSet::Graphics),
    (311, 106, 114, KBCSet::Graphics),
    (323, 106, 116, KBCSet::Graphics),
    (333, 106, 122, KBCSet::Graphics),
    (348, 106, 114, KBCSet::Graphics),
    (360, 106, 116, KBCSet::Graphics),
    (370, 106, 122, KBCSet::Graphics),
    (385, 106, 114, KBCSet::Graphics),
    (397, 106, 116, KBCSet::Graphics),
    (407, 106, 122, KBCSet::Graphics),
    (422, 106, 114, KBCSet::Graphics),
    (434, 106, 116, KBCSet::Graphics),
    (444, 106, 122, KBCSet::Graphics),
    (459, 106, 114, KBCSet::Graphics),
    (471, 106, 116, KBCSet::Graphics),
    (481, 106, 122, KBCSet::Graphics),
    (518, 106, 64, KBCSet::Graphics),
    (533, 106, 114, KBCSet::Graphics),
    (545, 106, 116, KBCSet::Graphics),
    (555, 106, 122, KBCSet::Graphics),
    (599, 106, 114, KBCSet::Graphics),
    (614, 106, 122, KBCSet::Graphics),
    (629, 106, 114, KBCSet::Graphics),
    (644, 106, 122, KBCSet::Graphics),
    (659, 106, 114, KBCSet::Graphics),
    (674, 106, 122, KBCSet::Graphics),
    (689, 106, 114, KBCSet::Graphics),
    (704, 106, 122, KBCSet::Graphics),
    (0, 116, 113, KBCSet::Graphics),
    (5, 116, 67, KBCSet::Labels),
    (10, 116, 111, KBCSet::Labels),
    (12, 116, 119, KBCSet::Graphics),
    (14, 116, 110, KBCSet::Labels),
    (18, 116, 116, KBCSet::Labels),
    (21, 116, 114, KBCSet::Labels),
    (22, 116, 119, KBCSet::Graphics),
    (24, 116, 111, KBCSet::Labels),
    (28, 116, 108, KBCSet::Labels),
    (37, 116, 119, KBCSet::Graphics),
    (52, 116, 101, KBCSet::Graphics),
    (67, 116, 113, KBCSet::Graphics),
    (82, 116, 119, KBCSet::Graphics),
    (89, 116, 101, KBCSet::Graphics),
    (104, 116, 113, KBCSet::Graphics),
    (116, 116, 119, KBCSet::Graphics),
    (126, 116, 101, KBCSet::Graphics),
    (141, 116, 113, KBCSet::Graphics),
    (153, 116, 119, KBCSet::Graphics),
    (163, 116, 101, KBCSet::Graphics),
    (178, 116, 113, KBCSet::Graphics),
    (190, 116, 119, KBCSet::Graphics),
    (200, 116, 101, KBCSet::Graphics),
    (215, 116, 113, KBCSet::Graphics),
    (227, 116, 119, KBCSet::Graphics),
    (237, 116, 101, KBCSet::Graphics),
    (252, 116, 113, KBCSet::Graphics),
    (264, 116, 119, KBCSet::Graphics),
    (274, 116, 101, KBCSet::Graphics),
    (289, 116, 113, KBCSet::Graphics),
    (301, 116, 119, KBCSet::Graphics),
    (311, 116, 101, KBCSet::Graphics),
    (326, 116, 113, KBCSet::Graphics),
    (338, 116, 119, KBCSet::Graphics),
    (348, 116, 101, KBCSet::Graphics),
    (363, 116, 113, KBCSet::Graphics),
    (375, 116, 119, KBCSet::Graphics),
    (385, 116, 101, KBCSet::Graphics),
    (400, 116, 113, KBCSet::Graphics),
    (412, 116, 119, KBCSet::Graphics),
    (422, 116, 101, KBCSet::Graphics),
    (437, 116, 113, KBCSet::Graphics),
    (449, 116, 119, KBCSet::Graphics),
    (459, 116, 101, KBCSet::Graphics),
    (474, 116, 113, KBCSet::Graphics),
    (479, 116, 82, KBCSet::Labels),
    (483, 116, 101, KBCSet::Labels),
    (485, 116, 49, KBCSet::Graphics),
    (487, 116, 116, KBCSet::Labels),
    (490, 116, 117, KBCSet::Labels),
    (494, 116, 114, KBCSet::Labels),
    (497, 116, 110, KBCSet::Labels),
    (533, 116, 113, KBCSet::Graphics),
    (546, 116, 119, KBCSet::Graphics),
    (555, 116, 101, KBCSet::Graphics),
    (599, 116, 113, KBCSet::Graphics),
    (614, 116, 101, KBCSet::Graphics),
    (629, 116, 113, KBCSet::Graphics),
    (644, 116, 101, KBCSet::Graphics),
    (659, 116, 113, KBCSet::Graphics),
    (674, 116, 101, KBCSet::Graphics),
    (689, 116, 113, KBCSet::Graphics),
    (704, 116, 101, KBCSet::Graphics),
    (518, 122, 64, KBCSet::Graphics),
    (74, 128, 97, KBCSet::Selected),
    (88, 128, 65, KBCSet::Selected),
    (111, 128, 115, KBCSet::Selected),
    (124, 128, 83, KBCSet::Selected),
    (148, 128, 100, KBCSet::Selected),
    (160, 128, 68, KBCSet::Selected),
    (185, 128, 102, KBCSet::Selected),
    (198, 128, 70, KBCSet::Selected),
    (222, 128, 103, KBCSet::Selected),
    (234, 128, 71, KBCSet::Selected),
    (259, 128, 104, KBCSet::Selected),
    (272, 128, 72, KBCSet::Selected),
    (296, 128, 106, KBCSet::Selected),
    (309, 128, 74, KBCSet::Selected),
    (333, 128, 107, KBCSet::Selected),
    (347, 128, 75, KBCSet::Selected),
    (370, 128, 108, KBCSet::Selected),
    (384, 128, 76, KBCSet::Selected),
    (406, 128, 91, KBCSet::Selected),
    (419, 128, 123, KBCSet::Selected),
    (444, 128, 93, KBCSet::Selected),
    (455, 128, 125, KBCSet::Selected),
    (541, 128, 126, KBCSet::Selected),
    (558, 128, 124, KBCSet::Selected),
    (603, 128, 23, KBCSet::Selected),
    (612, 128, 9, KBCSet::Selected),
    (633, 128, 24, KBCSet::Selected),
    (643, 128, 10, KBCSet::Selected),
    (663, 128, 25, KBCSet::Selected),
    (672, 128, 11, KBCSet::Selected),
    (694, 128, 29, KBCSet::Selected),
    (0, 138, 114, KBCSet::Graphics),
    (12, 138, 116, KBCSet::Graphics),
    (22, 138, 116, KBCSet::Graphics),
    (37, 138, 116, KBCSet::Graphics),
    (52, 138, 122, KBCSet::Graphics),
    (67, 138, 114, KBCSet::Graphics),
    (79, 138, 116, KBCSet::Graphics),
    (89, 138, 122, KBCSet::Graphics),
    (104, 138, 114, KBCSet::Graphics),
    (116, 138, 116, KBCSet::Graphics),
    (126, 138, 122, KBCSet::Graphics),
    (141, 138, 114, KBCSet::Graphics),
    (153, 138, 116, KBCSet::Graphics),
    (163, 138, 122, KBCSet::Graphics),
    (178, 138, 114, KBCSet::Graphics),
    (190, 138, 116, KBCSet::Graphics),
    (200, 138, 122, KBCSet::Graphics),
    (215, 138, 114, KBCSet::Graphics),
    (227, 138, 116, KBCSet::Graphics),
    (237, 138, 122, KBCSet::Graphics),
    (252, 138, 114, KBCSet::Graphics),
    (264, 138, 116, KBCSet::Graphics),
    (274, 138, 122, KBCSet::Graphics),
    (289, 138, 114, KBCSet::Graphics),
    (302, 138, 116, KBCSet::Graphics),
    (311, 138, 122, KBCSet::Graphics),
    (326, 138, 114, KBCSet::Graphics),
    (338, 138, 116, KBCSet::Graphics),
    (348, 138, 122, KBCSet::Graphics),
    (363, 138, 114, KBCSet::Graphics),
    (375, 138, 116, KBCSet::Graphics),
    (385, 138, 122, KBCSet::Graphics),
    (400, 138, 114, KBCSet::Graphics),
    (412, 138, 116, KBCSet::Graphics),
    (422, 138, 122, KBCSet::Graphics),
    (437, 138, 114, KBCSet::Graphics),
    (449, 138, 116, KBCSet::Graphics),
    (459, 138, 122, KBCSet::Graphics),
    (474, 138, 114, KBCSet::Graphics),
    (489, 138, 116, KBCSet::Graphics),
    (501, 138, 116, KBCSet::Graphics),
    (512, 138, 116, KBCSet::Graphics),
    (518, 138, 122, KBCSet::Graphics),
    (533, 138, 114, KBCSet::Graphics),
    (545, 138, 116, KBCSet::Graphics),
    (555, 138, 122, KBCSet::Graphics),
    (599, 138, 114, KBCSet::Graphics),
    (614, 138, 122, KBCSet::Graphics),
    (629, 138, 114, KBCSet::Graphics),
    (644, 138, 122, KBCSet::Graphics),
    (659, 138, 114, KBCSet::Graphics),
    (674, 138, 122, KBCSet::Graphics),
    (689, 138, 114, KBCSet::Graphics),
    (704, 138, 122, KBCSet::Graphics),
    (0, 148, 113, KBCSet::Graphics),
    (5, 148, 83, KBCSet::Labels),
    (9, 148, 104, KBCSet::Labels),
    (12, 148, 119, KBCSet::Graphics),
    (13, 148, 105, KBCSet::Labels),
    (15, 148, 102, KBCSet::Labels),
    (17, 148, 119, KBCSet::Graphics),
    (18, 148, 116, KBCSet::Labels),
    (32, 148, 101, KBCSet::Graphics),
    (47, 148, 113, KBCSet::Graphics),
    (62, 148, 119, KBCSet::Graphics),
    (69, 148, 101, KBCSet::Graphics),
    (84, 148, 113, KBCSet::Graphics),
    (96, 148, 119, KBCSet::Graphics),
    (106, 148, 101, KBCSet::Graphics),
    (121, 148, 113, KBCSet::Graphics),
    (133, 148, 119, KBCSet::Graphics),
    (143, 148, 101, KBCSet::Graphics),
    (158, 148, 113, KBCSet::Graphics),
    (170, 148, 119, KBCSet::Graphics),
    (180, 148, 101, KBCSet::Graphics),
    (195, 148, 113, KBCSet::Graphics),
    (207, 148, 119, KBCSet::Graphics),
    (217, 148, 101, KBCSet::Graphics),
    (232, 148, 113, KBCSet::Graphics),
    (244, 148, 119, KBCSet::Graphics),
    (254, 148, 101, KBCSet::Graphics),
    (269, 148, 113, KBCSet::Graphics),
    (283, 148, 119, KBCSet::Graphics),
    (291, 148, 101, KBCSet::Graphics),
    (306, 148, 113, KBCSet::Graphics),
    (318, 148, 119, KBCSet::Graphics),
    (328, 148, 101, KBCSet::Graphics),
    (343, 148, 113, KBCSet::Graphics),
    (355, 148, 119, KBCSet::Graphics),
    (365, 148, 101, KBCSet::Graphics),
    (380, 148, 113, KBCSet::Graphics),
    (392, 148, 119, KBCSet::Graphics),
    (402, 148, 101, KBCSet::Graphics),
    (417, 148, 113, KBCSet::Graphics),
    (429, 148, 119, KBCSet::Graphics),
    (439, 148, 101, KBCSet::Graphics),
    (454, 148, 113, KBCSet::Graphics),
    (459, 148, 83, KBCSet::Labels),
    (463, 148, 104, KBCSet::Labels),
    (466, 148, 119, KBCSet::Graphics),
    (467, 148, 105, KBCSet::Labels),
    (469, 148, 102, KBCSet::Labels),
    (471, 148, 119, KBCSet::Graphics),
    (472, 148, 116, KBCSet::Labels),
    (486, 148, 101, KBCSet::Graphics),
    (599, 148, 113, KBCSet::Graphics),
    (614, 148, 101, KBCSet::Graphics),
    (629, 148, 113, KBCSet::Graphics),
    (644, 148, 101, KBCSet::Graphics),
    (659, 148, 113, KBCSet::Graphics),
    (674, 148, 101, KBCSet::Graphics),
    (689, 148, 113, KBCSet::Graphics),
    (704, 148, 101, KBCSet::Graphics),
    (694, 150, 69, KBCSet::Labels),
    (698, 150, 110, KBCSet::Labels),
    (702, 150, 116, KBCSet::Labels),
    (705, 150, 101, KBCSet::Labels),
    (709, 150, 114, KBCSet::Labels),
    (54, 160, 60, KBCSet::Selected),
    (66, 160, 62, KBCSet::Selected),
    (91, 160, 121, KBCSet::Selected),
    (103, 160, 89, KBCSet::Selected),
    (128, 160, 120, KBCSet::Selected),
    (140, 160, 88, KBCSet::Selected),
    (165, 160, 99, KBCSet::Selected),
    (178, 160, 67, KBCSet::Selected),
    (200, 160, 118, KBCSet::Selected),
    (214, 160, 86, KBCSet::Selected),
    (239, 160, 98, KBCSet::Selected),
    (251, 160, 66, KBCSet::Selected),
    (276, 160, 110, KBCSet::Selected),
    (287, 160, 78, KBCSet::Selected),
    (312, 160, 109, KBCSet::Selected),
    (324, 160, 77, KBCSet::Selected),
    (350, 160, 44, KBCSet::Selected),
    (363, 160, 59, KBCSet::Selected),
    (387, 160, 46, KBCSet::Selected),
    (400, 160, 58, KBCSet::Selected),
    (425, 160, 45, KBCSet::Selected),
    (438, 160, 95, KBCSet::Selected),
    (603, 160, 20, KBCSet::Selected),
    (614, 160, 6, KBCSet::Selected),
    (633, 160, 21, KBCSet::Selected),
    (643, 160, 7, KBCSet::Selected),
    (663, 160, 22, KBCSet::Selected),
    (673, 160, 8, KBCSet::Selected),
    (0, 170, 114, KBCSet::Graphics),
    (12, 170, 116, KBCSet::Graphics),
    (17, 170, 116, KBCSet::Graphics),
    (32, 170, 122, KBCSet::Graphics),
    (47, 170, 114, KBCSet::Graphics),
    (59, 170, 116, KBCSet::Graphics),
    (69, 170, 122, KBCSet::Graphics),
    (84, 170, 114, KBCSet::Graphics),
    (96, 170, 116, KBCSet::Graphics),
    (106, 170, 122, KBCSet::Graphics),
    (121, 170, 114, KBCSet::Graphics),
    (133, 170, 116, KBCSet::Graphics),
    (143, 170, 122, KBCSet::Graphics),
    (158, 170, 114, KBCSet::Graphics),
    (170, 170, 116, KBCSet::Graphics),
    (180, 170, 122, KBCSet::Graphics),
    (195, 170, 114, KBCSet::Graphics),
    (207, 170, 116, KBCSet::Graphics),
    (217, 170, 122, KBCSet::Graphics),
    (232, 170, 114, KBCSet::Graphics),
    (244, 170, 116, KBCSet::Graphics),
    (254, 170, 122, KBCSet::Graphics),
    (269, 170, 114, KBCSet::Graphics),
    (283, 170, 116, KBCSet::Graphics),
    (291, 170, 122, KBCSet::Graphics),
    (306, 170, 114, KBCSet::Graphics),
    (318, 170, 116, KBCSet::Graphics),
    (328, 170, 122, KBCSet::Graphics),
    (343, 170, 114, KBCSet::Graphics),
    (355, 170, 116, KBCSet::Graphics),
    (365, 170, 122, KBCSet::Graphics),
    (380, 170, 114, KBCSet::Graphics),
    (392, 170, 116, KBCSet::Graphics),
    (402, 170, 122, KBCSet::Graphics),
    (417, 170, 114, KBCSet::Graphics),
    (429, 170, 116, KBCSet::Graphics),
    (439, 170, 122, KBCSet::Graphics),
    (454, 170, 114, KBCSet::Graphics),
    (466, 170, 116, KBCSet::Graphics),
    (471, 170, 116, KBCSet::Graphics),
    (486, 170, 122, KBCSet::Graphics),
    (599, 170, 114, KBCSet::Graphics),
    (614, 170, 122, KBCSet::Graphics),
    (629, 170, 114, KBCSet::Graphics),
    (644, 170, 122, KBCSet::Graphics),
    (659, 170, 114, KBCSet::Graphics),
    (674, 170, 122, KBCSet::Graphics),
    (689, 170, 112, KBCSet::Graphics),
    (704, 170, 64, KBCSet::Graphics),
    (47, 180, 113, KBCSet::Graphics),
    (52, 180, 65, KBCSet::Labels),
    (57, 180, 108, KBCSet::Labels),
    (59, 180, 116, KBCSet::Labels),
    (59, 180, 119, KBCSet::Graphics),
    (62, 180, 101, KBCSet::Labels),
    (66, 180, 114, KBCSet::Labels),
    (69, 180, 110, KBCSet::Labels),
    (69, 180, 119, KBCSet::Graphics),
    (73, 180, 97, KBCSet::Labels),
    (77, 180, 116, KBCSet::Labels),
    (80, 180, 101, KBCSet::Labels),
    (84, 180, 101, KBCSet::Graphics),
    (99, 180, 113, KBCSet::Graphics),
    (114, 180, 119, KBCSet::Graphics),
    (129, 180, 119, KBCSet::Graphics),
    (144, 180, 119, KBCSet::Graphics),
    (159, 180, 119, KBCSet::Graphics),
    (174, 180, 119, KBCSet::Graphics),
    (189, 180, 119, KBCSet::Graphics),
    (204, 180, 119, KBCSet::Graphics),
    (219, 180, 119, KBCSet::Graphics),
    (234, 180, 119, KBCSet::Graphics),
    (249, 180, 119, KBCSet::Graphics),
    (264, 180, 119, KBCSet::Graphics),
    (279, 180, 119, KBCSet::Graphics),
    (294, 180, 119, KBCSet::Graphics),
    (309, 180, 119, KBCSet::Graphics),
    (324, 180, 119, KBCSet::Graphics),
    (339, 180, 119, KBCSet::Graphics),
    (354, 180, 119, KBCSet::Graphics),
    (369, 180, 119, KBCSet::Graphics),
    (384, 180, 119, KBCSet::Graphics),
    (399, 180, 119, KBCSet::Graphics),
    (414, 180, 101, KBCSet::Graphics),
    (429, 180, 113, KBCSet::Graphics),
    (434, 180, 67, KBCSet::Labels),
    (439, 180, 97, KBCSet::Labels),
    (441, 180, 119, KBCSet::Graphics),
    (443, 180, 112, KBCSet::Labels),
    (447, 180, 115, KBCSet::Labels),
    (451, 180, 119, KBCSet::Graphics),
    (453, 180, 76, KBCSet::Labels),
    (457, 180, 111, KBCSet::Labels),
    (461, 180, 99, KBCSet::Labels),
    (465, 180, 107, KBCSet::Labels),
    (466, 180, 101, KBCSet::Graphics),
    (599, 180, 113, KBCSet::Graphics),
    (614, 180, 119, KBCSet::Graphics),
    (629, 180, 119, KBCSet::Graphics),
    (644, 180, 101, KBCSet::Graphics),
    (659, 180, 113, KBCSet::Graphics),
    (674, 180, 101, KBCSet::Graphics),
    (689, 180, 112, KBCSet::Graphics),
    (704, 180, 64, KBCSet::Graphics),
    (606, 192, 19, KBCSet::Selected),
    (620, 192, 5, KBCSet::Selected),
    (664, 192, 31, KBCSet::Selected),
    (47, 202, 114, KBCSet::Graphics),
    (59, 202, 116, KBCSet::Graphics),
    (69, 202, 116, KBCSet::Graphics),
    (84, 202, 122, KBCSet::Graphics),
    (99, 202, 114, KBCSet::Graphics),
    (114, 202, 116, KBCSet::Graphics),
    (129, 202, 116, KBCSet::Graphics),
    (144, 202, 116, KBCSet::Graphics),
    (159, 202, 116, KBCSet::Graphics),
    (174, 202, 116, KBCSet::Graphics),
    (189, 202, 116, KBCSet::Graphics),
    (204, 202, 116, KBCSet::Graphics),
    (219, 202, 116, KBCSet::Graphics),
    (234, 202, 116, KBCSet::Graphics),
    (249, 202, 116, KBCSet::Graphics),
    (264, 202, 116, KBCSet::Graphics),
    (279, 202, 116, KBCSet::Graphics),
    (294, 202, 116, KBCSet::Graphics),
    (309, 202, 116, KBCSet::Graphics),
    (324, 202, 116, KBCSet::Graphics),
    (339, 202, 116, KBCSet::Graphics),
    (354, 202, 116, KBCSet::Graphics),
    (369, 202, 116, KBCSet::Graphics),
    (384, 202, 116, KBCSet::Graphics),
    (399, 202, 116, KBCSet::Graphics),
    (414, 202, 122, KBCSet::Graphics),
    (429, 202, 114, KBCSet::Graphics),
    (441, 202, 116, KBCSet::Graphics),
    (451, 202, 116, KBCSet::Graphics),
    (466, 202, 122, KBCSet::Graphics),
    (599, 202, 114, KBCSet::Graphics),
    (614, 202, 116, KBCSet::Graphics),
    (629, 202, 116, KBCSet::Graphics),
    (644, 202, 122, KBCSet::Graphics),
    (659, 202, 114, KBCSet::Graphics),
    (674, 202, 122, KBCSet::Graphics),
    (689, 202, 114, KBCSet::Graphics),
    (704, 202, 122, KBCSet::Graphics),
];

pub const CHARS_GRAPH: [u8; 9] = [49, 64, 101, 112, 113, 114, 116, 119, 122];

pub const CHARS_LABEL: [u8; 25] = [
    65, 66, 67, 68, 69, 76, 82, 83, 84, 97, 98, 99, 101, 102, 104, 105, 107, 108, 110, 111, 112,
    114, 115, 116, 117,
];

#[derive(StructOpt)]
pub struct KBOptions {
    out: PathBuf,
}

fn get_gchar(gchar: u8) -> &'static EChar<'static> {
    match gchar {
        49 => &EChar {
            width: 15,
            height: 10,
            top: 0,
            buf: &[
                0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 255, 242, 255, 242, 0, 2, 255, 254,
            ],
        },
        64 => &EChar {
            width: 15,
            height: 24,
            top: 0,
            buf: &[
                0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18,
                0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18,
            ],
        },
        101 => &EChar {
            width: 15,
            height: 18,
            top: 6,
            buf: &[
                255, 254, 255, 254, 0, 2, 255, 242, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0,
                18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18,
            ],
        },
        112 => &EChar {
            width: 15,
            height: 24,
            top: 0,
            buf: &[
                144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0,
                144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0,
                144, 0, 144, 0, 144, 0, 144, 0,
            ],
        },
        113 => &EChar {
            width: 15,
            height: 18,
            top: 6,
            buf: &[
                255, 254, 255, 254, 128, 0, 159, 254, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144,
                0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0,
            ],
        },
        114 => &EChar {
            width: 15,
            height: 18,
            top: 0,
            buf: &[
                144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0, 144, 0,
                144, 0, 144, 0, 144, 0, 159, 254, 128, 0, 128, 0, 255, 254, 255, 254,
            ],
        },
        116 => &EChar {
            width: 15,
            height: 5,
            top: 13,
            buf: &[255, 254, 0, 0, 0, 0, 255, 254, 255, 254],
        },
        119 => &EChar {
            width: 15,
            height: 4,
            top: 6,
            buf: &[255, 254, 255, 254, 0, 0, 255, 254],
        },
        122 => &EChar {
            width: 15,
            height: 18,
            top: 0,
            buf: &[
                0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18, 0, 18,
                0, 18, 255, 242, 0, 2, 0, 2, 255, 254, 255, 254,
            ],
        },
        _ => &ECHAR_NULL,
    }
}

fn get_lchar(lchar: u8) -> &'static EChar<'static> {
    match lchar {
        65 => &EChar {
            width: 5,
            height: 7,
            top: 11,
            buf: &[32, 0, 32, 0, 80, 0, 80, 0, 112, 0, 136, 0, 136, 0],
        },
        66 => &EChar {
            width: 4,
            height: 7,
            top: 11,
            buf: &[96, 0, 80, 0, 80, 0, 112, 0, 80, 0, 80, 0, 96, 0],
        },
        67 => &EChar {
            width: 5,
            height: 7,
            top: 11,
            buf: &[48, 0, 72, 0, 64, 0, 64, 0, 64, 0, 72, 0, 48, 0],
        },
        68 => &EChar {
            width: 5,
            height: 7,
            top: 11,
            buf: &[112, 0, 72, 0, 72, 0, 72, 0, 72, 0, 72, 0, 112, 0],
        },
        69 => &EChar {
            width: 4,
            height: 7,
            top: 11,
            buf: &[112, 0, 64, 0, 64, 0, 112, 0, 64, 0, 64, 0, 112, 0],
        },
        76 => &EChar {
            width: 4,
            height: 7,
            top: 11,
            buf: &[64, 0, 64, 0, 64, 0, 64, 0, 64, 0, 64, 0, 112, 0],
        },
        82 => &EChar {
            width: 4,
            height: 7,
            top: 11,
            buf: &[96, 0, 80, 0, 80, 0, 96, 0, 96, 0, 80, 0, 80, 0],
        },
        83 => &EChar {
            width: 4,
            height: 7,
            top: 11,
            buf: &[48, 0, 80, 0, 64, 0, 96, 0, 16, 0, 80, 0, 96, 0],
        },
        84 => &EChar {
            width: 4,
            height: 7,
            top: 11,
            buf: &[112, 0, 32, 0, 32, 0, 32, 0, 32, 0, 32, 0, 32, 0],
        },
        97 => &EChar {
            width: 4,
            height: 5,
            top: 13,
            buf: &[96, 0, 16, 0, 112, 0, 80, 0, 112, 0],
        },
        98 => &EChar {
            width: 4,
            height: 7,
            top: 11,
            buf: &[64, 0, 64, 0, 112, 0, 80, 0, 80, 0, 80, 0, 112, 0],
        },
        99 => &EChar {
            width: 4,
            height: 5,
            top: 13,
            buf: &[112, 0, 80, 0, 64, 0, 80, 0, 112, 0],
        },
        101 => &EChar {
            width: 4,
            height: 5,
            top: 13,
            buf: &[112, 0, 80, 0, 112, 0, 64, 0, 112, 0],
        },
        102 => &EChar {
            width: 3,
            height: 7,
            top: 11,
            buf: &[32, 0, 64, 0, 224, 0, 64, 0, 64, 0, 64, 0, 64, 0],
        },
        104 => &EChar {
            width: 4,
            height: 7,
            top: 11,
            buf: &[64, 0, 64, 0, 112, 0, 80, 0, 80, 0, 80, 0, 80, 0],
        },
        105 => &EChar {
            width: 2,
            height: 7,
            top: 11,
            buf: &[64, 0, 0, 0, 64, 0, 64, 0, 64, 0, 64, 0, 64, 0],
        },
        107 => &EChar {
            width: 4,
            height: 7,
            top: 11,
            buf: &[64, 0, 64, 0, 80, 0, 80, 0, 96, 0, 80, 0, 80, 0],
        },
        108 => &EChar {
            width: 2,
            height: 7,
            top: 11,
            buf: &[64, 0, 64, 0, 64, 0, 64, 0, 64, 0, 64, 0, 64, 0],
        },
        110 => &EChar {
            width: 4,
            height: 5,
            top: 13,
            buf: &[112, 0, 80, 0, 80, 0, 80, 0, 80, 0],
        },
        111 => &EChar {
            width: 4,
            height: 5,
            top: 13,
            buf: &[112, 0, 80, 0, 80, 0, 80, 0, 112, 0],
        },
        112 => &EChar {
            width: 4,
            height: 7,
            top: 13,
            buf: &[112, 0, 80, 0, 80, 0, 80, 0, 112, 0, 64, 0, 64, 0],
        },
        114 => &EChar {
            width: 3,
            height: 5,
            top: 13,
            buf: &[112, 0, 64, 0, 64, 0, 64, 0, 64, 0],
        },
        115 => &EChar {
            width: 4,
            height: 5,
            top: 13,
            buf: &[112, 0, 64, 0, 112, 0, 16, 0, 112, 0],
        },
        116 => &EChar {
            width: 3,
            height: 6,
            top: 12,
            buf: &[64, 0, 224, 0, 64, 0, 64, 0, 64, 0, 32, 0],
        },
        117 => &EChar {
            width: 4,
            height: 5,
            top: 13,
            buf: &[80, 0, 80, 0, 80, 0, 80, 0, 112, 0],
        },
        _ => &ECHAR_NULL,
    }
}

fn _print_eset(needed: &[u8], set: &ESet, name: &str) {
    println!("match {} {{", name);
    for cval in needed.iter().copied() {
        let chr = &set.chars[cval as usize];
        print!("  {} => &EChar{{", cval);
        print!(" width: {},", chr.width);
        print!(" height: {},", chr.height);
        print!(" top: {},", chr.top);
        println!(" buf: &{:?}}},", chr.buf);
    }
    println!("  _ => panic!(),");
    println!("}}");
}

fn _run_stage_2() -> anyhow::Result<()> {
    let gfont = OwnedESet::load(Path::new("../chsets/GRAPH1.E24"))?;
    let lfont = OwnedESet::load(Path::new("../chsets/GROTMIKR.E24"))?;

    _print_eset(&CHARS_GRAPH[..], &gfont, "gchar");
    _print_eset(&CHARS_LABEL[..], &lfont, "lchar");
    Ok(())
}

pub fn run(file: &Path, buffer: &[u8], kbopt: KBOptions) -> anyhow::Result<()> {
    let (_, eset) = parse_eset(buffer) //
        .map_err(|e| anyhow!("Could not load editor charset:\n{}", e))?;
    let mut page = Page::new(730, 175);

    for (x, y, cval, cset) in KB_DRAW.iter().cloned() {
        let echr = match cset {
            KBCSet::Selected => &eset.chars[cval as usize],
            KBCSet::Graphics => get_gchar(cval),
            KBCSet::Labels => get_lchar(cval),
        };
        page.draw_echar(x + 6, y - 52, &echr);
    }

    let img = page.to_image();

    let mut out = kbopt.out;
    if out.exists() && out.is_dir() {
        out.push(file.file_name().unwrap());
        out.set_extension("png");
    }

    img.save_with_format(&out, ImageFormat::Png)?;

    Ok(())
}
